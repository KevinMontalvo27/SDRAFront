<div class="min-h-screen bg-base-200" *ngIf="topic$ | async as topic">
  <!-- Header -->
  <header
    class="bg-gradient-to-r from-primary to-secondary px-8 py-10 relative overflow-hidden"
  >
    <div class="relative z-10">
      <div class="breadcrumbs text-sm text-primary-content/70 mb-2">
        <ul>
          <li><span>Unidad</span></li>
          <li><span class="text-primary-content font-medium">Tema</span></li>
        </ul>
      </div>
      <h1 class="text-3xl md:text-4xl font-bold text-primary-content">
        {{ topic.nombre }}
      </h1>
    </div>
    <div
      class="absolute -top-1/2 -right-10 w-72 h-72 bg-white/10 rounded-full"
    ></div>

    <div class="gap-4 mt-6 flex">
      <button class="btn bg-gray-400 btn-primary" (click)="openEditTopic()">
        + Editar Tema
      </button>
      <button class="btn bg-gray-400 btn-primary" (click)="openCreateOa()">
        + Nuevo objeto de aprendizaje
      </button>
    </div>
  </header>

  <div
    *ngIf="showTopicModal && (topic$ | async) as editingTopic"
    class="modal modal-open"
  >
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">
        {{ editingTopic ? "Editar" : "Nuevo" }} Tema
      </h3>
      <form #topicForm="ngForm" (ngSubmit)="saveTopic(topicForm.value)">
        <div class="form-control">
          <label class="label"><span class="label-text">Título</span></label>
          <input
            type="text"
            name="nombre"
            [ngModel]="editingTopic?.nombre"
            class="input input-bordered"
            required
          />
        </div>
        <div class="form-control mt-3">
          <label class="label"
            ><span class="label-text">Descripción</span></label
          >
          <textarea
            name="description"
            [ngModel]="editingTopic?.descripcion"
            class="textarea textarea-bordered"
            required
          ></textarea>
        </div>
        <div class="form-control mt-3">
          <label class="label"><span class="label-text">Orden</span></label>
          <input
            type="number"
            name="order"
            [ngModel]="editingTopic?.numero_tema"
            class="input input-bordered"
            min="1"
            required
          />
        </div>
        <div class="modal-action">
          <button type="button" class="btn" (click)="showTopicModal = false">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div *ngIf="showObjectModal" class="modal modal-open">
    <div class="modal-box max-w-2xl">
      <h3 class="font-bold text-lg mb-4">Nuevo Objeto</h3>
      <form #objForm="ngForm" (ngSubmit)="saveObject(objForm, fileInput)">
        <input type="hidden" name="id_tema" [value]="1" ngModel />

        <div class="form-control">
          <label class="label"><span class="label-text">Título</span></label>
          <input
            type="text"
            name="nombre"
            ngModel
            class="input input-bordered"
            required
          />
        </div>

        <div class="form-control mt-3">
          <label class="label"
            ><span class="label-text">Descripción</span></label
          >
          <textarea
            name="descripcion"
            ngModel
            class="textarea textarea-bordered"
            required
          ></textarea>
        </div>

        <div class="form-control mt-3">
          <label class="label"><span class="label-text">Tipo</span></label>
          <!-- mantener referencia #typeSelect si la necesitas; el name y ngModel permiten leerlo desde form.value -->
          <select
            name="id_type"
            class="select select-bordered"
            required
            #typeSelect
            ngModel
          >
            <option value="1">Texto Plano</option>
            <option value="2">PDF</option>
            <option value="3">Video</option>
            <option value="4">Imagen</option>
            <option value="5">Audio</option>
          </select>
        </div>

        <!-- input de archivo con referencia template -->
        <div *ngIf="typeSelect.value !== '1'" class="form-control mt-3">
          <label class="label"><span class="label-text">Archivo</span></label>
          <input
            type="file"
            (change)="onFileSelected($event)"
            name="file"
            class="file-input file-input-bordered"
            #fileInput
          />
        </div>
        <div class="modal-action">
          <button type="button" class="btn" (click)="showObjectModal = false">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Description Card -->
  <div class="px-8 -mt-6 relative z-20" *ngIf="topic.descripcion">
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <div class="flex gap-4">
          <div
            class="w-12 h-12 flex items-center justify-center bg-primary/10 rounded-xl text-primary shrink-0"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
          </div>
          <div>
            <h3 class="font-semibold text-base-content mb-1">
              Descripción del tema
            </h3>
            <p class="text-base-content/70 leading-relaxed">
              {{ topic.descripcion }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Subtemas Card (NUEVO) -->
  <div
    class="px-8 mt-4 relative z-20"
    *ngIf="topic.subtemas && topic.subtemas.length > 0"
  >
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <div class="flex gap-4">
          <div
            class="w-12 h-12 flex items-center justify-center bg-secondary/10 rounded-xl text-secondary shrink-0"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 10h16M4 14h16M4 18h16"
              />
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="font-semibold text-base-content mb-3">Subtemas</h3>
            <ul class="space-y-2">
              <li
                *ngFor="let subtema of topic.subtemas; let i = index"
                class="flex items-start gap-3 text-base-content/70"
              >
                <span
                  class="flex items-center justify-center w-6 h-6 rounded-full bg-secondary/20 text-secondary text-xs font-semibold shrink-0 mt-0.5"
                >
                  {{ i + 1 }}
                </span>
                <span class="leading-relaxed">{{ subtema }}</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Resources Section -->
  <section class="p-8">
    <div class="flex items-center gap-4 mb-6">
      <div
        class="w-12 h-12 flex items-center justify-center bg-warning text-warning-content rounded-xl"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"
          />
        </svg>
      </div>
      <div>
        <h2 class="text-xl font-bold text-base-content">
          Objetos de aprendizaje
        </h2>
      </div>
    </div>

    <!-- Loading State -->
    <div
      *ngIf="!(objetos$ | async)"
      class="flex flex-col items-center justify-center py-16 bg-base-100 rounded-xl border-2 border-dashed border-base-300"
    >
      <span class="loading loading-spinner loading-lg text-primary mb-4"></span>
      <p class="text-base-content/60">Cargando recursos...</p>
    </div>

    <!-- Resources Grid -->
    <div
      *ngIf="oas"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"
    >
      <div
        *ngFor="let oa of oas"
        class="card bg-base-100 shadow-md hover:shadow-xl transition-all duration-200 hover:-translate-y-1 border border-base-300"
      >
        <div class="card-body p-4">
          <!-- Badge con el tipo de estilo -->
          <div class="flex items-center gap-2 mb-2">
            <div class="badge badge-primary badge-sm">
              {{ getEstiloTipo(oa) }}
            </div>
          </div>

          <!-- Título -->
          <h4 class="card-title text-base mb-2">{{ oa.objeto.nombre }}</h4>

          <!-- Botón -->
          <div
            class="card-actions justify-end mt-auto pt-3 border-t border-base-200"
          >
            <button
              class="btn btn-primary btn-sm gap-2 w-full"
              (click)="openResource(oa)"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                />
              </svg>
              Ver recurso
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
